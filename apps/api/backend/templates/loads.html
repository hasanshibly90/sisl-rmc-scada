<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Loads Report</title>
<style>
  body { font-family: Arial, "Noto Sans Bengali", sans-serif; font-size: 12px; color:#111; }
  h1 { font-size: 18px; margin: 0 0 6px 0; }
  .meta { margin: 0 0 12px 0; }
  table { width: 100%; border-collapse: collapse; }
  th, td { border:1px solid #333; padding: 4px 6px; }
  th { background:#eee; text-align: left; }
  .num { text-align: right; }
  .center { text-align:center; }
  .state-done { color: #0a7a0a; font-weight: bold; }
  .state-pending { color: #a00; font-weight: bold; }
  .state-running { color: #d18f00; font-weight: bold; }
  .zebra tr:nth-child(even) td { background:#f7f7f7; }
  .small { font-size: 11px; color:#444; }
</style>
</head>
<body>
  <h1>Deliveries — Loads (per 1 m³ rows)</h1>
  <div class="meta">
    <div><strong>Order:</strong> #{{order.id}} &nbsp; <strong>Client:</strong> {{client}} &nbsp; <strong>Recipe:</strong> {{recipe}}</div>
    {% if vehicle %}<div><strong>Vehicle:</strong> {{vehicle.name}} (id={{vehicle.id}})</div>{% endif %}
    <div class="small">Tolerance (Δ%) visual rule: ±{{tolerance_pct}}%</div>
  </div>

  <table class="zebra">
    <thead>
      <tr>
        <th class="center">Row#</th>
        <th class="center">m³</th>
        <th colspan="3" class="center">Cement (Set / Act / Δ)</th>
        <th colspan="3" class="center">Sand (Set / Act / Δ)</th>
        <th colspan="3" class="center">Agg1 (Set / Act / Δ)</th>
        <th colspan="3" class="center">Agg2 (Set / Act / Δ)</th>
        <th colspan="3" class="center">Water (Set / Act / Δ)</th>
        <th colspan="3" class="center">Admix (Set / Act / Δ)</th>
        <th class="center">State</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td class="center">{{r.seq}}</td>
        <td class="center">{{'%.3f' % r.m3}}</td>
        {% set set = r.set %}{% set act=r.act %}{% set d=r.delta %}
        {% for mat in ['cement','sand','agg1','agg2','water','admix'] %}
          <td class="num">{{'%.3f' % set[mat]}}</td>
          <td class="num">{{ ( '%.3f' % act[mat] ) if act[mat] is not none else '-' }}</td>
          <td class="num">{{ ( '%.3f' % d[mat] ) if d[mat] is not none else '-' }}</td>
        {% endfor %}
        <td class="center state-{{r.state}}">{{r.state.upper()}}</td>
      </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <th colspan="1">Totals</th>
        <th class="center">{{'%.3f' % totals.planned_m3}}</th>
        {% for mat in ['cement','sand','agg1','agg2','water','admix'] %}
          <th class="num">{{'%.3f' % totals.set[mat]}}</th>
          <th class="num">{{'%.3f' % totals.act[mat]}}</th>
          <th class="num">{{'%.3f' % totals.delta[mat]}}</th>
        {% endfor %}
        <th></th>
      </tr>
    </tfoot>
  </table>

  <p class="small">Each row = 1 m³ (or fractional last row). Set = per-m³ recipe scaled by the row’s m³.</p>
</body>
</html>
